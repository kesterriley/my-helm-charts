#!/usr/bin/env bash

# Steven Wade <steven@stevenwade.co.uk @swade1987 http://www.stevenwade.co.uk>
# Kester Riley <kesterriley@hotmail.com>

set -o errexit
set -o nounset
set -o pipefail

: "${REPOSITORY_URL:?Environment variable REPOSITORY_URL must be set}"
: "${GIT_USERNAME:?Environment variable GIT_USERNAME must be set}"
: "${GIT_EMAIL:?Environment variable GIT_EMAIL must be set}"

TMP_DIR=/tmp/charts

helm init --client-only

mkdir -p ${TMP_DIR}
cd ${TMP_DIR}

#HTTPS clone
#git clone ${REPOSITORY_URL}

# SSH clone
git clone ${CIRCLE_REPOSITORY_URL}

cd ${TMP_DIR}/${CIRCLE_PROJECT_REPONAME}

rm -rf index.yaml
rm -rf *.tgz

for chart in charts/*
do
 if [ $chart == 'charts/README.md' ]
 then
    continue
 fi
 printf "\nChecking %s\n" "${chart#*/}"
 helm package ${chart} --destination .
done

helm repo index . --url https://${GIT_USERNAME}.github.io/${CIRCLE_PROJECT_REPONAME}

git config user.email "$GIT_EMAIL"
git config user.name "$GIT_USERNAME"

git checkout gh-pages

git add .
git commit --message="Update index.yaml" --signoff
git push "$REPOSITORY_URL" gh-pages
